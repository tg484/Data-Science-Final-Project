---
title: "Geospatial Analysis - Final Project"
author: "Payal Soneja"
output:
  html_document: 
    df_print: paged
  pdf_document:
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r include = FALSE}
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

```

```{r, results = "hide"}
#Set Up: Install the following packages and load the libraries.
#packages <- c("tidyverse", "readr","dials", "ranger", "parsnip","lubridate",
             # "leaflet", "sf", "tigris", "arcos",
             # "sp", "rmapshaper")
#if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
#  install.packages(setdiff(packages, rownames(installed.packages())), repos = "https://cran.us.r-project.org")  
#}

library(tidyverse)
library(lubridate)
library(ggiraph) # to use geom_sf_interactive
library(tigris)
library(sf)
library(leaflet)
library(patchwork)
library(tidymodels)
library(themis)
library(rpart.plot)
library(vip)
library(parsnip)
library(dials)
library(ranger)

```

```{r extraction, results = "hide"}
# Extracting the csv file from harvard dataverse website
data_url <- "https://dataverse.harvard.edu/api/access/datafile/4949558"

download.file(
  data_url,
  destfile = "voting_data.csv",
  mode = "wb"
)

```

```{r load data and clean, results = "hide"}
# load the data
voting_data <- read_csv("voting_data.csv") %>%
  select(CC20_401, birthyr, gender, educ, race, CC20_332a, CC20_302, CC20_309e, CC20_350b, urbancity, ideo5, pew_religimp, ownhome, newsint, faminc_new, investor, internethome, sexuality, CC20_331e, gunown, child18, votereg, CC20_307, CC20_303, employ, marstat, immstat, union, phone, presvote16post, inputstate, dualcit, region, healthins_1, healthins_2, healthins_3, healthins_4, healthins_5, healthins_6, CC20_430a_1, CC20_430a_2, CC20_430a_3, CC20_430a_4, CC20_430a_5, CC20_430a_6, CC20_430a_7, CC20_430a_8, numchildren, dualcit, CC20_300_1, CC20_300_2, CC20_300_3, CC20_300_4, CC20_300_5, inputstate, countyfips, countyname)
  
# filter registered voters and drop missing values
voting_data <- voting_data %>%
  filter(votereg == 1) %>%
  mutate(age = 2020 - birthyr) %>%
  select(-birthyr) %>%
  na.omit()

# create a binary variable for voted or not and convert to factor
voting_data <- voting_data %>% 
    mutate(voted = if_else(condition = CC20_401 == 5, true = 1,
                               false = 0))%>%
  mutate(voted = factor(voted, labels = c("1", "0"), levels = c("1", "0")))

# drop voter registration (since it is a prerequisite, not a predictor)
voting_data <- voting_data %>% 
  select(-votereg)
```


``` {r, results = "hide"}
# download county shape files from tigris package
counties_sf <- counties(cb=TRUE)

# download state shape files from tigris package
states_sf <- states(cb=TRUE)

```

## Geospatial Analysis


``` {r echo=FALSE}
# create a function for plotting a variable by counties
plot_counties_map <- function(perc_data, var_name, title, col_palette='Blues') {
  
  # join with counties shapefile 
  counties_perc_data <- geo_join(counties_sf, perc_data, "GEOID", "countyfips") 
  counties_perc_data <- counties_perc_data %>% na.omit()

  # create color palette 
  pal <- colorNumeric(col_palette, domain = counties_perc_data[[ var_name ]])

  # set up the tootltip
  popup_sb <- paste0(counties_perc_data$NAME, ", ", counties_perc_data$STATE_NAME, "</br/>", title,": \n", as.character(counties_perc_data[[ var_name ]]*100))
  
  
  # map voter_count_perc with the new tiles CartoDB.Positron
  leaflet() %>%
    addProviderTiles("CartoDB.Positron") %>%
    setView(-98.483330, 38.712046, zoom = 4) %>% 
    addPolygons(data = counties_perc_data , 
                fillColor = ~pal(counties_perc_data[[var_name]]), 
                fillOpacity = 1, 
                weight = 0.9, 
                smoothFactor = 0.5, 
                stroke=TRUE,
                color="white",
                popup = ~popup_sb) %>%
    addLegend(pal = pal, 
              values = counties_perc_data[[var_name]], 
              labFormat = labelFormat(suffix = '%', between = '% - ',
                                                   transform = function(x) 100 * x),
              position = "bottomright",
              title = title)
  
}

```

``` {r echo=FALSE}
# create a function for plotting a variable by states
plot_states_map <- function(perc_data, var_name, title, col_palette='Blues') {
  
  # join with states shapefile 
  states_perc_data <- geo_join(states_sf, perc_data, "GEOID", "statefips") 
  states_perc_data <- states_perc_data %>% na.omit()

  # create color palette 
  pal <- colorNumeric(col_palette, domain = states_perc_data[[ var_name ]])

  # set up the tootltip
  popup_sb <- paste0(states_perc_data$NAME, "</br/>", title,": \n", as.character(states_perc_data[[ var_name ]]*100))
  
  
  # map voter_count_perc with the new tiles CartoDB.Positron
  leaflet() %>%
    addProviderTiles("CartoDB.Positron") %>%
    setView(-98.483330, 38.712046, zoom = 4) %>% 
    addPolygons(data = states_perc_data , 
                fillColor = ~pal(states_perc_data[[var_name]]), 
                fillOpacity = 1, 
                weight = 0.9, 
                smoothFactor = 0.5, 
                stroke=TRUE,
                color="white",
                popup = ~popup_sb) %>%
    addLegend(pal = pal, 
              values = states_perc_data[[var_name]], 
              labFormat = labelFormat(suffix = '%', between = '% - ',
                                                   transform = function(x) 100 * x),
              position = "bottomright",
              title = title)
  
}
```


### Voter Turnout by County

``` {r}
voter_turnout_county <- voting_data %>%
  mutate(voted = ifelse(as.numeric(voted) == 1,1,0)) %>%
  group_by(countyfips, countyname) %>%
  summarise(voter_count_perc = mean(voted)) %>%
  na.omit()


plot_counties_map(voter_turnout_county, 'voter_count_perc', 'Voter Turnout %')
```
`

### 1. Voter Turnout by State

The map below shows what percentage of respondents voted (responded yes) in the 2020 election for each state.

``` {r}
voter_turnout_state <- voting_data %>%
  mutate(voted = ifelse(voted == 1,1,0)) %>%
  mutate(statefips=sprintf("%02d", inputstate)) %>%
  group_by(statefips) %>%
  summarise(voter_count_perc = mean(voted))


plot_states_map(voter_turnout_state, 'voter_count_perc', 'Voter Turnout %')

```

From this map, we wanted to understand if there is a difference between voting turnout by state, and if so by how much. As we can see from the map, voter turnout in most of the states was > 90%. Southern states had relatively lower % of respondents who voted, in particular Mississipi, Oklahoma, Arkansas, and Alabama. 


### 2. Conservative Ideology by State

To calculate the number of respondents with conservative ideology, we looked at the variable `ideo5` which corresponds to the question: "In general, how would you describe your own political viewpoint?". Responses "Very Conservative" and "Conservative" were counted for this analysis.

```{r}
cons_perc_state <- voting_data %>%
  mutate(conservative = ifelse(ideo5 %in% c(4,5),1,0)) %>%
  mutate(statefips=sprintf("%02d", inputstate)) %>%
  group_by(statefips) %>%
  summarise(cons_count_perc = mean(conservative))

plot_states_map(cons_perc_state, 'cons_count_perc', 'Conservative Respondents %', 'Reds')

```

With this map, we want to understand which states had highest or lowest respondents with conservative ideology in order to understand the respondents better, and also to understand if the findings here match our hypothesis about Blue and Red States. As we can see from the plot, Wyoming, South Dakota, North Dakota, and Tennessee had highest % of respondents who had a conservative viewpoint. We can also see that mid western and southern states generally have more conservative leaning respondents than states like Massachusetts, California, New York, and Vermont where this percentage is less than 25%.  



### Conservative Ideology by County

```{r}
cons_perc_county <- voting_data %>%
  mutate(conservative = ifelse(ideo5 %in% c(4,5),1,0)) %>%
  group_by(countyfips) %>%
  summarise(cons_count_perc = mean(conservative))

plot_counties_map(cons_perc_county, 'cons_count_perc', 'Conservative Respondents %', 'Reds')

```


### 3. Gun Ownership by State

To calculate Gun Ownership, we look at the variable `gunown` which corresponds to the question: "Do you or does anyone in your household own a gun?". We choose the responses "Personally own a gun" and "Don't personally own a gun, but someone in the household owns a gun" as relevant for this analysis.


``` {r}
gun_perc_state <- voting_data %>%
  mutate(gunownership = ifelse(gunown %in% c(1,2),1,0)) %>%
  mutate(statefips=sprintf("%02d", inputstate)) %>%
  group_by(statefips) %>%
  summarise(gun_count_perc = mean(gunownership))

plot_states_map(gun_perc_state, 'gun_count_perc', 'Gun Ownership %', 'YlOrRd')


```


Gun ownership % is highest in West Virginia (58%), closely followed by Wyomoing, Montana, and Alabama. On the other hand, Massachusetts, New York, New Jersey, DC, Conneticut have relatively low gun ownership % (less than 20%). We also observe that there might be some correlation with previous analysis, where more conservative states also have higher gun ownership %.

#### States with maximum and minimum gun ownership

```{r echo=FALSE}

#states_gun_perc %>%
#  slice_max(gun_count_perc) ## West Virginia has the highest percentage of respondents with gun ownership

#states_gun_perc %>%
#  slice_min(gun_count_perc) ## District of Columbia has the lowest percentage of respondents with gun ownership

```

### 4. Comparing High and Low Gun Ownership States

Next, we wanted to compare West Virginia (58% respondents with gun ownership), and Massachusetts (14.5% respondents with gun ownership) in context of safety. We look at the variable `police_unsafe` which corresponds to the survey question "Do the police make you feel...?". Here we classify options "Somewhat Unsafe"  and "Mostly Unsafe" as "unsafe" category and count the number of respondents who chose these 2 options.

```{r}

police_unsafe_county <- voting_data %>%
    mutate(police_unsafe = ifelse(CC20_307 %in% c(3,4),1,0)) %>%
    group_by(countyfips) %>%
    summarise(police_unsafe_perc = mean(police_unsafe))

counties_police_unsafe_perc <- geo_join(counties_sf, police_unsafe_county , "GEOID", "countyfips")
counties_police_unsafe_perc <- subset(counties_police_unsafe_perc, !is.na(police_unsafe_perc))

# filter for west virginia
wv_police_unsafe_perc <- counties_police_unsafe_perc %>%
  filter(STATEFP == "54")

# filter for MA
ma_police_unsafe_perc <- counties_police_unsafe_perc %>%
  filter(STATEFP == "25")
```

#### 4.1 West Virginia v/s Massachusetts (Counties)

The counties maps for the two states below shows % of respondents that said police makes them feel "unsafe". 

```{r}

# create tooltip : State: Unsafe %
wv_police_unsafe_perc$tooltip <- paste0(wv_police_unsafe_perc$NAME,
                                 ": ",
                                 round(wv_police_unsafe_perc$police_unsafe_perc*100, 2), '%')

# Interactive geom_sf to plot Percentage of respondents that said police makes them unsafe in West Virginia
wv_police_unsafe_perc_plot <- ggplot() +
  geom_sf_interactive(data = wv_police_unsafe_perc, color = "white", aes(fill = police_unsafe_perc, 
                      tooltip = tooltip, data_id = GEOID), size = 0.5) +
  labs(title = "Percentage of Respondents that said police makes them feel unsafe",
       subtitle = "In West Virginia",
       caption = "Source: Harvard CEES Data",
       fill = "Percentage of responsents") +
  theme(legend.position = "right") +
   scale_fill_gradient(low = "#56B1F7", high = "#132B43", labels = scales::percent, limits = c(0,1)) +
  theme_void()

# Add hover color
wv_police_unsafe_perc_plot <- girafe(ggobj = wv_police_unsafe_perc_plot) %>%
  girafe_options(opts_hover(css = "fill:cyan;"), 
                 opts_zoom(max = 10))

wv_police_unsafe_perc_plot

# Interactive geom_sf to plot Percentage of respondents that said police makes them unsafe in Massachusetts
ma_police_unsafe_perc$tooltip <- paste0(ma_police_unsafe_perc$NAME,
                                 ": ",
                                 round(ma_police_unsafe_perc$police_unsafe_perc*100, 2), '%')

ma_police_unsafe_perc_plot <- ggplot() +
  geom_sf_interactive(data = ma_police_unsafe_perc, color = "white", aes(fill = police_unsafe_perc, 
                      tooltip = tooltip, data_id = GEOID), size = 0.5) +
  labs(title = "Percentage of Respondents that said police makes them feel unsafe",
       subtitle = "In Massachusets",
       caption = "Source: Harvard CEES Data",
       fill = "Percentage of responsents") +
  theme(legend.position = "right") +
   scale_fill_gradient(low = "#56B1F7", high = "#132B43", labels = scales::percent, limits = c(0,1)) +
  theme_void()

# Add hover color
ma_police_unsafe_perc_plot <- girafe(ggobj = ma_police_unsafe_perc_plot) %>%
  girafe_options(opts_hover(css = "fill:cyan;"), 
                 opts_zoom(max = 10))

ma_police_unsafe_perc_plot 

```

#### 2016 Voter Turnout by State

``` {r}
vote16_perc_state <- voting_data %>%
  mutate(voted16 = ifelse(presvote16post %in% c(1,2,3,4,5,6),1,0)) %>%
  mutate(statefips=sprintf("%02d", inputstate)) %>%
  group_by(statefips) %>%
  summarise(vote16_perc = mean(voted16))

plot_states_map(vote16_perc_state, 'vote16_perc', 'Voter Turnout % (2016)')

```
